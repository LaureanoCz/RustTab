<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='./css/layout.css') }}">
    <!-- Estilos para cada pagina independiente del layout -->
    {% block styles %}{% endblock %}
</head>
<body>
    <header>
        <div class="header-icons-1">
            <a href="{{url_for('home')}}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-home">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M3 12l2 -2l7 -7l7 7l2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z" />
                <path d="M9 21v-6a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v6" />
            </svg>
            </a>

            <svg id="searchIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-search" style="cursor: pointer;">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                <path d="M21 21l-6 -6" />
            </svg>

            <svg id="headerFav" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-star"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" /></svg>

        </div>

        <div class="header-icons-2" id="headerIcons3">
            {% if current_user.is_authenticated %}
                <div class="user-menu-container">
                    <a href="#" id="userMenuToggle" class="user-icon-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-user">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                            <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                        </svg>
                    </a>
                    <div id="userDropdown" class="user-dropdown" style="display: none;">
                        <div class="user-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-user">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                                <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                            </svg>
                        </div>
                        <div class="user-info">
                            <p class="username">{{ current_user.username }}</p>
                        </div>
                        <div class="dropdown-actions">
                            <a href="#" id="logoutBtn" class="logout-btn">Cerrar sesión</a>
                        </div>
                    </div>
                </div>
            {% else %}
                <a href="{{url_for('login')}}">
                    <svg id="openModal" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-login-2">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M9 8v-2a2 2 0 0 1 2 -2h7a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-7a2 2 0 0 1 -2 -2v-2" />
                        <path d="M3 12h13l-3 -3" />
                        <path d="M13 15l3 -3" />
                    </svg>
                </a>
            {% endif %}
        </div>
        </div>
    </header>
    <!-- Logout notification modal -->
    <div id="logoutNotification" class="logout-notification" style="display: none;">
        <div class="logout-notification-content">
            <p>Ha cerrado sesión correctamente.</p>
        </div>
    </div>
    <!-- Search Modal -->
    <div id="searchModal" class="search-modal" style="display: none;">
        <div class="search-modal-content">
            <div class="search-header">
                <input type="text" id="searchInput" class="searchInput" placeholder="Buscar canciones...">
                <span id="closeSearchModal" class="close-search-btn">✕</span>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>
    </div>
    <!-- Favorite login modal (reusable) -->
    <div id="fav-login-modal" class="fav-modal" style="display: none;">
        <div class="fav-modal-content">
            <p>Debes iniciar sesión para usar favoritos.</p>
            <div class="fav-modal-actions">
                <button id="fav-modal-login">Ir a Login</button>
                <button id="fav-modal-close">Cancelar</button>
            </div>
        </div>
    </div>
    {% block body %}
    {% endblock %}
    <script>
        // Expose authentication status to JS
        const isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};
        // Store URLs for use in JavaScript
        const logoutUrl = '{{ url_for("logout") }}';
        const loginUrl = '{{ url_for("login") }}';
        
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // User dropdown toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Check for login success notification
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('login') === 'success') {
                const loginSuccessNotification = document.getElementById('loginSuccessNotification');
                if (loginSuccessNotification) {
                    loginSuccessNotification.style.display = 'flex';
                    
                    // Auto-hide after 3 seconds
                    setTimeout(function() {
                        loginSuccessNotification.style.display = 'none';
                    }, 3000);
                    
                    // Clean URL (remove query parameter)
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
            const userMenuToggle = document.getElementById('userMenuToggle');
            const userDropdown = document.getElementById('userDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            const headerIcons3 = document.getElementById('headerIcons3');
            
            if (userMenuToggle && userDropdown) {
                // Toggle dropdown when user icon is clicked
                userMenuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    const isVisible = userDropdown.style.display === 'block';
                    userDropdown.style.display = isVisible ? 'none' : 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userMenuToggle.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.style.display = 'none';
                    }
                });
            }
            
            // Handle logout via AJAX
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Make AJAX request to logout
                    fetch(logoutUrl, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Replace the header content with login icon
                            headerIcons3.innerHTML = `
                                <a href="${loginUrl}">
                                    <svg id="openModal" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-login-2">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M9 8v-2a2 2 0 0 1 2 -2h7a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-7a2 2 0 0 1 -2 -2v-2" />
                                        <path d="M3 12h13l-3 -3" />
                                        <path d="M13 15l3 -3" />
                                    </svg>
                                </a>
                            `;
                            
                            // Show logout notification modal
                            const logoutNotification = document.getElementById('logoutNotification');
                            if (logoutNotification) {
                                logoutNotification.style.display = 'flex';
                                
                                // Auto-hide after 3 seconds
                                setTimeout(function() {
                                    logoutNotification.style.display = 'none';
                                }, 3000);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error during logout:', error);
                        // Fallback: reload page if AJAX fails
                        window.location.reload();
                    });
                });
            }

            // Header favorites icon behavior: open favorites if logged, otherwise show modal
            const headerFav = document.getElementById('headerFav');
            const favLoginModal = document.getElementById('fav-login-modal');
            if(headerFav){
                headerFav.style.cursor = 'pointer';
                headerFav.addEventListener('click', function(e){
                    e.preventDefault();
                    if(isAuthenticated){
                        window.location.href = '/favoritos';
                    } else {
                        // open existing reusable modal
                        if(favLoginModal){ favLoginModal.style.display = 'flex'; }
                    }
                });
            }

            // Favorite modal actions
            const favModalLoginBtn = document.getElementById('fav-modal-login');
            const favModalCloseBtn = document.getElementById('fav-modal-close');
            if(favModalLoginBtn) favModalLoginBtn.addEventListener('click', function(){ window.location.href = '/login'; });
            if(favModalCloseBtn) favModalCloseBtn.addEventListener('click', function(){ if(favLoginModal) favLoginModal.style.display = 'none'; });
        });

        const searchApiUrl = '{{ url_for("search_songs") }}';
        
        // Search functionality
        let searchTimeout;
        const searchIcon = document.getElementById('searchIcon');
        const searchModal = document.getElementById('searchModal');
        const closeSearchModal = document.getElementById('closeSearchModal');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        
        // Open search modal
        if (searchIcon) {
            searchIcon.addEventListener('click', function() {
                if (searchModal) {
                    searchModal.style.display = 'flex';
                    if (searchInput) {
                        searchInput.focus();
                    }
                    // Load all songs when modal opens
                    performSearch('');
                }
            });
        }
        
        // Close search modal
        if (closeSearchModal) {
            closeSearchModal.addEventListener('click', function() {
                if (searchModal) {
                    searchModal.style.display = 'none';
                    if (searchInput) {
                        searchInput.value = '';
                    }
                    if (searchResults) {
                        searchResults.innerHTML = '';
                    }
                }
            });
        }
        
        // Close modal when clicking outside
        if (searchModal) {
            searchModal.addEventListener('click', function(e) {
                if (e.target === searchModal) {
                    searchModal.style.display = 'none';
                    if (searchInput) {
                        searchInput.value = '';
                    }
                    if (searchResults) {
                        searchResults.innerHTML = '';
                    }
                }
            });
        }
        
        // Real-time search as user types
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                clearTimeout(searchTimeout);
                
                // Debounce search - wait 300ms after user stops typing
                // If query is empty, show all songs
                searchTimeout = setTimeout(function() {
                    performSearch(query);
                }, 300);
            });
            
            // Handle Enter key
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = e.target.value.trim();
                    clearTimeout(searchTimeout);
                    performSearch(query);
                }
            });
        }
        
        // Perform search function
        function performSearch(query) {
            if (!searchResults) return;
            
            // Show loading state
            searchResults.innerHTML = '<div class="search-loading">Buscando...</div>';
            
            // Fetch results from API
            const url = query ? `${searchApiUrl}?q=${encodeURIComponent(query)}` : `${searchApiUrl}?q=`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        searchResults.innerHTML = '<div class="search-error">Error al buscar canciones</div>';
                        return;
                    }
                    
                    const songs = data.songs || [];
                    
                    if (songs.length === 0) {
                        searchResults.innerHTML = '<div class="search-no-results">No se encontraron canciones</div>';
                        return;
                    }
                    
                    // Display results
                    let resultsHTML = '';
                    songs.forEach(song => {
                        // Use titulo as the route parameter (it's the <title> in /song/<title>)
                        const slug = song.slug || song.titulo.toLowerCase()
                            .replace(/\s+/g, '_')
                            .replace(/[^a-z0-9_]/g, '');
                        
                        // Store song data in data attributes for click handler
                        resultsHTML += `
                            <div class="search-result-item" 
                                 data-song-id="${song.id}" 
                                 data-song-slug="${escapeHtml(slug)}"
                                 data-song-title="${escapeHtml(song.titulo)}">
                                <div class="result-info">
                                    <div class="result-texts">
                                        <p class="title">${escapeHtml(song.titulo)}</p>
                                        <p class="artist">${escapeHtml(song.artista)}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    searchResults.innerHTML = resultsHTML;
                    
                    // Add click handlers to results
                    const resultItems = searchResults.querySelectorAll('.search-result-item');
                    resultItems.forEach(item => {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            const songId = this.getAttribute('data-song-id');
                            const songSlug = this.getAttribute('data-song-slug');
                            
                            // Build URL using slug (title)
                            const songUrl = `/song/${encodeURIComponent(songSlug)}`;
                            console.log('Navigating to:', songUrl); // Debug log
                            window.location.href = songUrl;
                        });
                    });
                })
                .catch(error => {
                    console.error('Search error:', error);
                    searchResults.innerHTML = '<div class="search-error">Error al buscar canciones</div>';
                });
        }
    </script>
</body>
</html>